---
description: "Helps enforce automatic fixing of failing CheckMate checks by continuing fix attempts until max_attempts is reached. Use when verification fails to ensure comprehensive fixing."
type: "Agent Requested"
globs: 
alwaysApply: false
---
# CheckMate ¬∑ Auto-Fix Enforcer

This rule ensures that when a feature validation fails, CheckMate continuously attempts fixes until it reaches max_attempts.

```rule type=activation
activationTrigger:
  event: after_command
  pattern: "checkmate audit --spec"
  maxRuns: 5  # Match max_attempts from .checkmate
```

```rule type=on_activation
# Check if audit failed
if [ $? -ne 0 ]; then
  # Get current fix count from environment
  CURRENT_FIX_COUNT=${CM_FIX_COUNT:-0}
  MAX_FIX_ATTEMPTS=$(grep -A 2 "auto_fix:" .checkmate | grep "max_attempts" | awk '{print $2}')
  MAX_FIX_ATTEMPTS=${MAX_FIX_ATTEMPTS:-5}  # Default to 5
  
  # Extract spec name from command
  SPEC_NAME=$(echo "$CURSOR_COMMAND" | grep -o '\--spec [^ ]*' | awk '{print $2}')
  
  # Increment counter
  NEXT_FIX_COUNT=$((CURRENT_FIX_COUNT + 1))
  
  if [ $NEXT_FIX_COUNT -le $MAX_FIX_ATTEMPTS ]; then
    echo "üîÑ Feature validation failed for $SPEC_NAME. Auto-fix attempt $NEXT_FIX_COUNT/$MAX_FIX_ATTEMPTS..."
    
    # Set the new fix count
    export CM_FIX_COUNT=$NEXT_FIX_COUNT
    
    # Show explicit message about continuing
    echo "‚ö†Ô∏è MUST CONTINUE fixing until all checks pass or reach max attempts ($MAX_FIX_ATTEMPTS)"
    echo "üìù Analyzing failed checks and implementing targeted fixes..."
    
    # Rerun audit with auto-sync to try fixing
    node ./dist/index.js audit --spec $SPEC_NAME --auto-sync --force
    
    if [ $? -eq 0 ]; then
      echo "‚úÖ Auto-fix successful on attempt $NEXT_FIX_COUNT!"
      exit 0
    else
      echo "‚ö†Ô∏è Auto-fix attempt $NEXT_FIX_COUNT failed. Will continue fixing until max attempts reached."
      # Note: The rule will be triggered again automatically on next command
    fi
  else
    echo "‚ùå Reached maximum fix attempts ($MAX_FIX_ATTEMPTS) for $SPEC_NAME"
    echo "üë®‚Äçüíª Manual intervention required to fix remaining issues."
  fi
fi
```